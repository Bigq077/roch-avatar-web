<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Roch AI Receptionist Demo</title>

  <style>
    body { font-family: Arial, sans-serif; max-width: 860px; margin: 40px auto; padding: 0 16px; }
    h1 { margin-top: 18px; }
    #chat { border: 1px solid #ddd; border-radius: 8px; padding: 12px; min-height: 220px; max-height: 420px; overflow:auto; background:#fff; }
    .msg { margin: 10px 0; line-height: 1.4; }
    .me { font-weight: 700; }
    .ai { font-weight: 700; }
    textarea { width: 100%; height: 70px; padding: 10px; border-radius: 10px; border: 1px solid #ddd; }
    button { padding: 10px 14px; cursor: pointer; border-radius: 10px; border: 1px solid #ddd; background: #fff; }
    button:hover { background: #f7f7f7; }
    button[disabled] { opacity: 0.5; cursor: not-allowed; }
    .row { display: flex; gap: 10px; align-items: center; margin-top: 10px; flex-wrap: wrap; }
    input { padding: 8px; border-radius: 10px; border: 1px solid #ddd; }
    small { color: #666; }
    .hint { margin-top: 10px; }
    .card { border:1px solid #eee; border-radius: 12px; padding:12px; background:#fafafa; }
    <div class="row">
    <button id="q1">Services</button>
    <button id="q2">Book appointment</button>
    <button id="q3">Opening hours</button>
    </div>


    /* Top bar */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 100;
      height: 64px;
      background: #0f172a;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      margin-bottom: 14px;
    }
    .topbar-left { display:flex; flex-direction:column; line-height:1.1; }
    .clinic-name { font-weight:600; font-size:15px; }
    .subtitle { font-size:12px; opacity:0.75; }
    .status { font-size:12px; padding:6px 10px; border-radius:999px; font-weight:500; }
    .status.ready { background: rgba(34,197,94,0.15); color:#22c55e; }
    .status.thinking { background: rgba(234,179,8,0.15); color:#eab308; }
    .status.speaking { background: rgba(59,130,246,0.15); color:#3b82f6; }
    .status.error { background: rgba(239,68,68,0.15); color:#ef4444; }
  </style>
</head>

<body>
  <!-- Top bar -->
  <header class="topbar">
    <div class="topbar-left">
      <div class="clinic-name">Roch Solutions Clinic</div>
      <div class="subtitle">AI Receptionist</div>
    </div>
    <div class="topbar-right">
      <span id="status" class="status ready">Ready</span>
    </div>
  </header>

  <h1>Roch AI Receptionist ‚Äî Voice-First Demo</h1>
  <p><small>Text + Voice ‚Üí AI brain ‚Üí ElevenLabs TTS (base64). No video, no LiveKit.</small></p>

  <div class="row">
    <label>Clinic ID:</label>
    <input id="clinicId" value="demo" />
    <label>Session ID:</label>
    <input id="sessionId" />
  </div>

  <div class="row" style="margin-top:14px;">
    <div style="flex:1; min-width: 320px;">
      <div id="chat"></div>

      <div class="row">
        <textarea id="message" placeholder="Type a question (e.g. 'What are your opening hours?')"></textarea>
      </div>

      <div class="row">
        <button id="sendBtn">Send</button>
        <button id="recBtn">üéô Record</button>
        <button id="stopRecBtn" disabled>‚èπ Stop</button>
        <button id="stopSpeakBtn">üîá Stop voice</button>
      </div>

      <p class="hint">
        <small>
          Text ‚Üí <code>/avatar/chat</code> (brain) ‚Üí ElevenLabs voice<br/>
          Voice ‚Üí <code>/avatar/voice-turn</code> (STT + brain) ‚Üí ElevenLabs voice<br/>
        </small>
      </p>
    </div>
  </div>

  <script>
    // ---------------------------
    // CONFIG
    // ---------------------------
    const BACKEND_BASE_URL = "https://rochsolutions-ai-receptionist.onrender.com";

    // ---------------------------
    // SESSION
    // ---------------------------
    const sessionIdInput = document.getElementById("sessionId");
    const clinicIdInput = document.getElementById("clinicId");
    const existing = localStorage.getItem("roch_session_id");
    const newId = existing || (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()));
    localStorage.setItem("roch_session_id", newId);
    sessionIdInput.value = newId;

    const chat = document.getElementById("chat");
    const statusEl = document.getElementById("status");

    const sendBtn = document.getElementById("sendBtn");
    const messageEl = document.getElementById("message");

    const recBtn = document.getElementById("recBtn");
    const stopRecBtn = document.getElementById("stopRecBtn");
    const stopSpeakBtn = document.getElementById("stopSpeakBtn");

    function setStatus(text) {
      const t = text || "";
      statusEl.textContent = t;

      statusEl.classList.remove("ready","thinking","speaking","error");
      const low = t.toLowerCase();
      if (low.includes("think")) statusEl.classList.add("thinking");
      else if (low.includes("speak") || low.includes("upload") || low.includes("record")) statusEl.classList.add("speaking");
      else if (low.includes("error")) statusEl.classList.add("error");
      else statusEl.classList.add("ready");
    }

    function setBusy(isBusy) {
      sendBtn.disabled = isBusy;
      recBtn.disabled = isBusy;
      messageEl.disabled = isBusy;
      clinicIdInput.disabled = isBusy;
      sessionIdInput.disabled = isBusy;
    }

    function addMsg(who, text) {
      const div = document.createElement("div");
      div.className = "msg";
      div.innerHTML = `<span class="${who === "You" ? "me" : "ai"}">${who}:</span> ${escapeHtml(text)}`;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    // ---------------------------
    // AUDIO (ElevenLabs via backend)
    // ---------------------------
    let currentAudio = null;

    function stopSpeaking() {
      if (currentAudio) {
        try { currentAudio.pause(); } catch {}
        currentAudio = null;
      }
    }

    stopSpeakBtn.onclick = () => {
      stopSpeaking();
      setStatus("Ready");
      setBusy(false);
    };

    async function speakEleven(text) {
      if (!text) return;

      stopSpeaking(); // prevent overlap
      setStatus("Speaking‚Ä¶");

      const res = await fetch(`${BACKEND_BASE_URL}/avatar/tts-eleven`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text })
      });

      if (!res.ok) throw new Error(await res.text());
      const data = await res.json();

      const audio = new Audio(`data:${data.mime_type};base64,${data.audio_b64}`);
      currentAudio = audio;

      audio.onended = () => {
        if (currentAudio === audio) currentAudio = null;
        setStatus("Ready");
        setBusy(false);
      };

      audio.onerror = () => {
        if (currentAudio === audio) currentAudio = null;
        setStatus("Ready");
        setBusy(false);
      };

      await audio.play();
    }

    // ---------------------------
    // TEXT CHAT
    // ---------------------------
    async function send() {
      const clinic_id = clinicIdInput.value.trim();
      const session_id = sessionIdInput.value.trim();
      const message = messageEl.value.trim();
      if (!message) return;

      stopSpeaking(); // if user interrupts mid-speech
      addMsg("You", message);
      messageEl.value = "";

      setBusy(true);
      setStatus("Thinking‚Ä¶");

      try {
        const res = await fetch(`${BACKEND_BASE_URL}/avatar/chat`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ clinic_id, session_id, message })
        });

        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        const replyText = data.reply_text || "(no reply)";

        addMsg("AI", replyText);
        await speakEleven(replyText);
      } catch (err) {
        console.error(err);
        setStatus("Error");
        setBusy(false);
      }
    }

    sendBtn.onclick = send;

    document.getElementById("q1").onclick = () => { messageEl.value = "What services do you offer?"; send(); };
    document.getElementById("q2").onclick = () => { messageEl.value = "Can I book an appointment?"; send(); };
    document.getElementById("q3").onclick = () => { messageEl.value = "What are your opening hours?"; send(); };


    messageEl.onkeydown = e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    };

    // ---------------------------
    // VOICE INPUT (STT + brain)
    // ---------------------------
    let mediaRecorder, audioChunks = [], stream;

    recBtn.onclick = async () => {
      stopSpeaking();

      try {
        stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      } catch (e) {
        alert("Microphone permission denied.");
        return;
      }

      audioChunks = [];
      mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm;codecs=opus" });

      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

      mediaRecorder.onstop = async () => {
        stream.getTracks().forEach(t => t.stop());
        const blob = new Blob(audioChunks, { type: "audio/webm" });
        await handleVoiceBlob(blob);
      };

      mediaRecorder.start();
      recBtn.disabled = true;
      stopRecBtn.disabled = false;
      setStatus("Recording‚Ä¶");
    };

    stopRecBtn.onclick = () => {
      mediaRecorder.stop();
      stopRecBtn.disabled = true;
      setStatus("Uploading‚Ä¶");
    };

    async function handleVoiceBlob(blob) {
      setBusy(true);

      try {
        const fd = new FormData();
        fd.append("clinic_id", clinicIdInput.value.trim());
        fd.append("session_id", sessionIdInput.value.trim());
        fd.append("audio", blob, "speech.webm");

        const sttRes = await fetch(`${BACKEND_BASE_URL}/avatar/voice-turn`, {
          method: "POST",
          body: fd
        });

        if (!sttRes.ok) throw new Error(await sttRes.text());
        const sttData = await sttRes.json();

        const transcript = (sttData.transcript || "").trim();
        const replyText = (sttData.reply_text || "").trim();

        if (!transcript) {
          setStatus("Could not transcribe ‚Äî try again.");
          setBusy(false);
          recBtn.disabled = false;
          stopRecBtn.disabled = true;
          return;
        }

        addMsg("You", transcript);

        if (replyText) {
          addMsg("AI", replyText);
          await speakEleven(replyText);
        } else {
          setStatus("No reply.");
          setBusy(false);
        }
      } catch (err) {
        console.error(err);
        setStatus("Error");
        setBusy(false);
      } finally {
        recBtn.disabled = false;
        stopRecBtn.disabled = true;
      }
    }

    // Initial status
    setStatus("Ready");
  </script>
</body>
</html>
