<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Roch Avatar Chat Test</title>

  <!-- ‚úÖ LiveKit client (LOCAL FILE ‚Äì bulletproof) -->
  <script defer src="/livekit-client.umd.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; max-width: 860px; margin: 40px auto; padding: 0 16px; }
    #chat { border: 1px solid #ddd; border-radius: 8px; padding: 12px; min-height: 220px; max-height: 360px; overflow:auto; }
    .msg { margin: 10px 0; }
    .me { font-weight: 700; }
    .ai { font-weight: 700; }
    textarea { width: 100%; height: 70px; padding: 10px; }
    button { padding: 10px 14px; cursor: pointer; }
    button[disabled] { opacity: 0.5; cursor: not-allowed; }
    .row { display: flex; gap: 10px; align-items: center; margin-top: 10px; flex-wrap: wrap; }
    input { padding: 8px; }
    small { color: #666; }
    .hint { margin-top: 8px; }
    .card { border:1px solid #eee; border-radius: 12px; padding:12px; }
    #avatarWrap { display:flex; gap:16px; flex-wrap: wrap; align-items:flex-start; }
    #avatarVideo { width: 320px; max-width: 100%; border-radius: 12px; background: #000; }
    #status, #liveStatus { min-height: 18px; }
  </style>
</head>

<body>
<h1>Roch Avatar Chat ‚Äî Interactive Avatar (Mode 2)</h1>
<p><small>Text + Voice ‚Üí AI brain ‚Üí LiveAvatar (LiveKit)</small></p>

<div class="row">
  <label>Clinic ID:</label>
  <input id="clinicId" value="demo" />
  <label>Session ID:</label>
  <input id="sessionId" />
</div>

<div id="avatarWrap" class="row">
  <div class="card">
    <div class="row">
      <strong>Avatar</strong>
      <button id="connectLiveBtn">üü¢ Connect Live</button>
      <button id="disconnectLiveBtn" disabled>üî¥ Disconnect</button>
    </div>

    <small id="liveStatus">Not connected.</small>
    <video id="avatarVideo" playsinline autoplay muted></video>

    <label>
      <input type="checkbox" id="muteToggle" checked />
      Muted (recommended)
    </label>
  </div>

  <div style="flex:1; min-width:320px;">
    <div id="chat"></div>

    <textarea id="message" placeholder="Type a question‚Ä¶"></textarea>

    <div class="row">
      <button id="sendBtn">Send</button>
      <button id="recBtn">üéô Record</button>
      <button id="stopRecBtn" disabled>‚èπ Stop</button>
      <span id="status"></span>
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const BACKEND_BASE_URL = "https://rochsolutions-ai-receptionist.onrender.com";

/* ================= SESSION ================= */
const sessionIdInput = document.getElementById("sessionId");
const clinicIdInput = document.getElementById("clinicId");

const existing = localStorage.getItem("roch_session_id");
const newId = existing || (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()));
localStorage.setItem("roch_session_id", newId);
sessionIdInput.value = newId;

/* ================= HELPERS ================= */
const chat = document.getElementById("chat");
const statusEl = document.getElementById("status");
const liveStatusEl = document.getElementById("liveStatus");
const messageEl = document.getElementById("message");
const videoEl = document.getElementById("avatarVideo");

function addMsg(who, text) {
  const div = document.createElement("div");
  div.className = "msg";
  div.innerHTML = `<b>${who}:</b> ${text}`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}
function setStatus(t){ statusEl.textContent = t || ""; }
function setLiveStatus(t){ liveStatusEl.textContent = t || ""; }

/* ================= LIVEKIT ================= */
let room = null;
let liveSession = null;

function getLiveKit() {
  return window.LiveKit || window.livekit || window.LivekitClient;
}

async function connectLiveAvatar() {
  const LK = getLiveKit();
  if (!LK || !LK.Room) {
    setLiveStatus("LiveKit not loaded.");
    return;
  }

  setLiveStatus("Starting session‚Ä¶");

  const res = await fetch(`${BACKEND_BASE_URL}/avatar/live/start`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      clinic_id: clinicIdInput.value,
      session_id: sessionIdInput.value
    })
  });

  liveSession = await res.json();

  room = new LK.Room({ adaptiveStream: true, dynacast: true });

  room.on("trackSubscribed", (track) => {
    if (track.kind === "video") {
      track.attach(videoEl);
      videoEl.play().catch(()=>{});
      setLiveStatus("Live Avatar connected ‚úÖ");
    }
  });

  room.on("dataReceived", (payload) => {
    try {
      JSON.parse(new TextDecoder().decode(payload));
    } catch {}
  });

  room.on("disconnected", () => {
    setLiveStatus("Disconnected.");
  });

  await room.connect(liveSession.livekit_url, liveSession.livekit_token);

  document.getElementById("connectLiveBtn").disabled = true;
  document.getElementById("disconnectLiveBtn").disabled = false;
}

async function disconnectLiveAvatar() {
  if (room) room.disconnect();
  room = null;
  setLiveStatus("Disconnected.");
}

/* ================= SPEAK (FIXED FOR v1) ================= */
async function speakOnAvatar(text) {
  if (!room || !text || !liveSession?.liveavatar_session_id) return false;

  const msg = {
    event_type: "avatar.speak_text",
    session_id: liveSession.liveavatar_session_id,
    text: text,
    channel: "agent-control"
  };

  try {
    const bytes = new TextEncoder().encode(JSON.stringify(msg));
    await room.localParticipant.publishData(bytes, true);
    return true;
  } catch (e) {
    console.warn("publishData failed:", e);
    return false;
  }
}

/* ================= TEXT CHAT ================= */
async function send() {
  const message = messageEl.value.trim();
  if (!message) return;

  addMsg("You", message);
  messageEl.value = "";
  setStatus("Thinking‚Ä¶");

  const res = await fetch(`${BACKEND_BASE_URL}/avatar/chat`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      clinic_id: clinicIdInput.value,
      session_id: sessionIdInput.value,
      message
    })
  });

  const data = await res.json();
  addMsg("AI", data.reply_text);

  setStatus("Speaking‚Ä¶");
  await speakOnAvatar(data.reply_text);
  setStatus("OK");
}

/* ================= EVENTS ================= */
document.getElementById("connectLiveBtn").onclick = connectLiveAvatar;
document.getElementById("disconnectLiveBtn").onclick = disconnectLiveAvatar;
document.getElementById("sendBtn").onclick = send;
document.getElementById("muteToggle").onchange = e => videoEl.muted = e.target.checked;

/* ================= CLEANUP (NECESSARY) ================= */
window.addEventListener("beforeunload", () => {
  try { if (room) room.disconnect(); } catch {}
});
</script>
</body>
</html>
